<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Tarefas - TechSolutions</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <h2>ğŸ¢ TechSolutions - Tarefas</h2>
        <div>
            <span id="userName"></span>
            <button type="button" onclick="logout()" class="btn-logout">Sair</button>
        </div>
    </nav>

    <div class="container">
        <div class="menu">
            <a href="/dashboard" class="btn">Dashboard</a>
            <a href="/tarefas" class="btn">Tarefas</a>
            <a href="/nova-tarefa" class="btn btn-success">+ Nova Tarefa</a>
        </div>

        <h2>ğŸ“‹ Todas as Tarefas</h2>

        <div class="filters">
            <input type="text" id="search" placeholder="Buscar tarefas..." onkeyup="searchTasks()">
            <select id="statusFilter" onchange="filterTasks()">
                <option value="">Todos status</option>
                <option value="pending">Pendentes</option>
                <option value="in_progress">Em andamento</option>
                <option value="completed">ConcluÃ­das</option>
            </select>
        </div>

        <div id="tasksList">
            Carregando tarefas...
        </div>
    </div>

    <script>
        // Verificar login
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) {
            window.location.href = '/login';
        } else {
            document.getElementById('userName').textContent = user.name;
        }

        let allTasks = [];

        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks');
                const data = await response.json();
                
                if (data.success) {
                    allTasks = data.tasks;
                    displayTasks(allTasks);
                }
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('tasksList').innerHTML = '<p>Erro ao carregar tarefas.</p>';
            }
        }

        function displayTasks(tasks) {
            if (tasks.length === 0) {
                document.getElementById('tasksList').innerHTML = '<p>Nenhuma tarefa encontrada.</p>';
                return;
            }

            const html = tasks.map(task => `
                <div class="task-card">
                    <div class="task-header">
                        <h3>${task.title}</h3>
                        <span class="priority ${task.priority}">
                            ${task.priority === 'high' ? 'ğŸ”´ Alta' : 
                              task.priority === 'medium' ? 'ğŸŸ¡ MÃ©dia' : 'ğŸŸ¢ Baixa'}
                        </span>
                    </div>
                    <p>${task.description || 'Sem descriÃ§Ã£o'}</p>
                    <div class="task-info">
                        <span><strong>Cliente:</strong> ${task.client_name}</span>
                        <span><strong>Categoria:</strong> ${task.category}</span>
                        <span><strong>Prazo:</strong> ${task.due_date || 'NÃ£o definido'}</span>
                        <span class="status ${task.status}">
                            ${task.status === 'completed' ? 'âœ… ConcluÃ­da' : 
                              task.status === 'in_progress' ? 'ğŸ”„ Em andamento' : 'â³ Pendente'}
                        </span>
                    </div>
                    <div class="task-actions">
                        <a href="/tarefa/${task.id}" class="btn">Ver detalhes</a>
                        <button onclick="deleteTask(${task.id})" class="btn-danger">Excluir</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('tasksList').innerHTML = html;
        }

        function searchTasks() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const filtered = allTasks.filter(task => 
                task.title.toLowerCase().includes(searchTerm) ||
                task.description.toLowerCase().includes(searchTerm) ||
                task.client_name.toLowerCase().includes(searchTerm)
            );
            displayTasks(filtered);
        }

        function filterTasks() {
            const status = document.getElementById('statusFilter').value;
            let filtered = allTasks;
            
            if (status) {
                filtered = allTasks.filter(task => task.status === status);
            }
            
            displayTasks(filtered);
        }

        async function deleteTask(id) {
            if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                try {
                    const response = await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Tarefa excluÃ­da com sucesso!');
                        loadTasks(); // Recarregar lista
                    }
                } catch (error) {
                    alert('Erro ao excluir tarefa');
                }
            }
        }

        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                });
        }

        // Carregar tarefas ao iniciar
        loadTasks();
    </script>
</body>
</html>